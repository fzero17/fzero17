---
layout: post
title:  "记录一次重构的经历"
date:   2017-11-25 10:20:40 +0800
categories: memo
---

# 记录一次重构的经历

web项目有一些长期遗留下来的未解决的问题，改来改去总是重复出问题，索性用一个迭代（两周）的时间把代码重构了。在这期间又去 [GitHub](https://github.com/dvajs/dva) 上把 dva 的文档和 issues 看了一遍，发现自己对于 dva 的理解有些错误和不全面的地方，一些问题找到了比较好的解决方案，重构也得以顺便进行。

### 问题1 state的变化
Modal 弹框数据无法及时更新，使用 New 组件的方法在保存时总是重复闪现。

出现这种问题是由于状态树的变化引起了组件的变化，但是我并没有找到问题代码，索性把控制 Modal 的代码重构了，用一个单独的 model 来控制 Modal 的显示和隐藏，数据的变化和 Modal 的状态就没有关联了，这样子，组件里的代码也变得简洁多了。

### 问题2 某些页面加载过慢

这个问题完全是由于前期码力不足造成的。将功能分离，有些页面要重复请求一个 uri 两次，把他们分开，在执行具体的操作时再去请求，减少无谓的网络请求。
还有一种情况就是 React 的组件嵌套比较复杂，这部分的代码直接用 HTML + JavaScript + jQuery + jQueryUI 重构了，其实我个人不太喜欢使用 jQuery ，更喜欢使用原生 JavaScript ，奈何项目赶的急，自己的技术能力也不够，暂时又留下了一笔技术债在这里。

### 问题3 Component的重构
组件的功能在自己的内部控制，去掉冗余的代码。有一个组件是一个方便用户切换查询数据的，把放在父组件中的事件响应代码都挪到了组件本身中，这样子又少写了很多代码，整个代码结构看起来又清晰了很多，并且在添加新的功能时，不需要再去考虑在新的功能组件中向这个组件中传递 props （其实还有很多其他的控件需要这样的重构）。

### 问题4 React 和 iFrame
在 React 框架中保证数据可以正确的传入 iframe 框架。为什么要在项目中使用 iframe？因为Web 要和 Android 端使用同样的 HTML 代码，在一开始找的解决方案都是通过父 iframe 去调用 子iframe 的方法，但是经常遇到子 iframe 中的 window.onload 还没有完成就已经执行了父 iframe 的代码。最近才突然想通：可以在子 iframe 中 window.onload 后通知父 iframe ，一直无法解决的 bug 迎刃而解 。

这个其实我前几天记录的一个[问题](https://github.com/fzero17/fzero17.github.io/issues/1) 。

### 总结
对于重构这件事情应该经常做，小到变量名的修改，都应该经常做的。这样子，在项目代码慢慢积累的时候，想要进行大型的重构才不至于措手不及。

